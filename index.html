<!DOCTYPE html>
<html>
  <head>
    <title>Personal Finance Chart</title>
    <script src="bower_components/papaparse/papaparse.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  </head>
  <body>

    CSV file:<input type="file" id="file-input" onchange="readBawagpskCSVandUpdateChart()"></input>
    Current Balance: <input type="text" id="balance-input" style="width:70px" onchange="readBawagpskCSVandUpdateChart()"></input>

    <div id="linechart-dailybalance"></div>

    <script>

      var lineChart;

      google.charts.load('current', {packages: ['line']});
      google.charts.setOnLoadCallback(function() {
        // new linechart without content (height will be 0)
        lineChart = new google.charts.Line(document.getElementById('linechart-dailybalance'));
      });

      var data = {
        correction: 0,
        bookings: null,
        dailyBalancesBaseZero: null,
        dailyBalances: null
      };

      var addDays = function(date, days) {
        // add a number of days to a given date
        var result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
      };

      var prepareBawagpskBookingData = function(rawBookingData) {
        // takes raw booking data (imported from Bawag PSK CSV) and returns a nicer format:
        // [
        //   {date: 2011-03-07, amount: 107.5},
        //   {date: 2011-03-10, amount: -23.05},...
        // ]
        var bookingData = [];
        for (var i = rawBookingData.length-2; i >= 0; i --) {
          var dayMonthYear = rawBookingData[i][2].split('.').reverse().join('-');
          var isoDate = new Date(dayMonthYear + 'T12:00:00');
          var amount = parseFloat(rawBookingData[i][4].replace('.', '').replace(',', '.'));
          bookingData.push({date: isoDate, amount: amount});
        }
        return bookingData;
      };

      var bookingsToDailyBalances = function(bookings, startBalance) {
        // takes a list of bookings (and an optional start balance) and returns daily account balances
        // (up until today)
        // format: [{date:..., balance:...}, {date:..., balance:...}, ...]
        var previousBalance = startBalance || 0;
        var dailyBalances = [];
        // index of the last unprocessed booking
        var unprocessedBookingIndex = 0;
        var today = new Date();
        today.setHours(1);
        var date = bookings[0].date;
        while (date <= today) {
          date = addDays(date, 1);
          // increase "date" and add all unprocessed bookings that occur before it
          while (unprocessedBookingIndex < bookings.length && bookings[unprocessedBookingIndex].date < date) {
            previousBalance += bookings[unprocessedBookingIndex].amount;
            unprocessedBookingIndex ++;
          }
          dailyBalances.push({date: date, balance: previousBalance});
        }
        return dailyBalances;
      }

      var updateChartFromDailyBalances = function(dailyBalances) {
        var data = new google.visualization.DataTable();
        data.addColumn('date', 'Date');
        data.addColumn('number', 'Balance');
        var rows = [];
        dailyBalances.forEach(function(element, index) {
          rows.push([element.date, element.balance]);
        });
        data.addRows(rows);
        var options = {
          chart: {
            title: 'Account balance'
          },
          width: 900,
          height: 500,
          // these actually don't work in material design charts for now
          enableInteractivity: false,
          tooltip: {trigger: 'selection'}
        };
        lineChart.draw(data, options);
      }

      var correctDailyBalancesByAmount = function(dailyBalances, amount) {
        for (var i = 0; i < dailyBalances.length; i ++) {
          dailyBalances[i].balance += amount;
        }
        return dailyBalances;
      };

      var readBawagpskCSVandUpdateChart = function() {
        // parse the CSV file
        Papa.parse(document.getElementById('file-input').files[0], {
          delimiter: ';',
          complete: function(results) {
            data.bookings = prepareBawagpskBookingData(results.data);
            data.dailyBalancesBaseZero = bookingsToDailyBalances(data.bookings);
            data.correction =
              parseFloat(document.getElementById('balance-input').value) -
              data.dailyBalancesBaseZero[data.dailyBalancesBaseZero.length-1].balance || 0;
            data.dailyBalances = correctDailyBalancesByAmount(data.dailyBalancesBaseZero, data.correction);
            updateChartFromDailyBalances(data.dailyBalances);
          }
        });
      }
    </script>
  </body>
</html>
